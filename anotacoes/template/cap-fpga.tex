%% ------------------------------------------------------------------------- %%
\chapter{FPGA}
\label{cap:fpga}

Este capítulo descreve o que é um FPGA e do que são essencialmente compostos. As descrições aqui feitas foram sintetizadas a partir das obras de \cite{fpga:fpga-for-dummies} e \cite{fpga:fpga-an-overview}.

\section{Introdução}
\label{section:introducao}

\textit{FPGA}s (do inglês \textit{Field Programmable Gate Array}) são dispositivos de silício que podem ser programados após sua fabricação, permitindo que quase qualquer \textit{design} de circuito digital possa ser implementado nele. Essa maleabilidade torna-os atrativos para tarefas que envolvam a produção e alteração de \textit{designs} de circuitos lógicos, pois o custo e tempo de execução dessas atividades são muito reduzidos em comparação ao tradicional ciclo de desenvolvimento com o uso de dispositivos \textit{ASIC}s (do inglês \textit{Application-Specific Integrated Circuit}).


\section{Reprogramabilidade}

A flexibilidade do \textit{FPGA} se deve à sua capacidade de ser reprogramada após sua fabricação. Para tanto, interruptores programáveis são posicionados em suas rotas de interconexão. Como esses interruptores (também conhecidos como \textit{switch}s) são componentes eletrônicos que redirecionam a corrente elétrica, é necessário que o interruptor seja configurado para que cada corrente de entrada seja desviada para a rota certa. Isso é feito a partir de memórias, que são programadas juntas do FPGA ao subir um programa no \textit{chip} ou na placa que o contém.

Além das rotas de interconexão, as portas lógicas do FPGA também devem ser arranjadas de tal forma que o processamento dos dados seja feito de acordo com o especificado pelo usuário. Ao invés de criar um possível esquema de tradução da linguagem de especificação de hardware para funções booleanas, são empregadas as chamadas \textit{LUTs} (\textit{lookup tables}). 

Para definir qual o circuito implementado no \textit{chip}, certas tecnologias de programação de circuitos são usadas, memórias para guardar os estados dos \textit{switchs} e de outros componentes. Idealmente, essas memórias são não-voláteis, infinitamente reprogramáveis, baratas e que consumam pouca energia. Atualmente, a tecnologia mais utilizada é a \textit{SRAM}, que não atinge todos os critérios ideais mas suas desvantagens podem ser facilmente contornadas.

A \textit{SRAM} (\textit{'Static Random Access Memory'}, ou 'memória estática de acesso aleatório') é um tipo de memória volátil que utiliza uma combinação de 6 transístores para guardar um \textit{bit} de informação. O termo 'estático' refere-se à falta de necessidade de atualizações de memória (\textit{memory refreshes}) em seu circuito. Note que isso não significa que, na ausência de corrente elétrica, o estado se manterá: caso haja uma queda de energia, a memória perderá o dado nela contido.

Devido à sua característica estática, as \textit{SRAM}s são mais rápidas e consomem menos energia que as \textit{DRAM}s. Entretanto, como as \textit{SRAM}s necessitam de 6 transistores, ao contrário das \textit{DRAM}s que utilizam apenas 1 transistor e 1 capacitor, aquelas são muito mais caras e demandam mais espaço no circuito para serem implementadas, além de ambas serem voláteis. ~\cite{hls:hls-from-alg-to-circuit}


\section{Componentes}

A composição de um \textit{FPGA} pode ser resumido em três componentes:

\begin{description}
\item[Blocos lógicos] - blocos de \textit{hardware} responsáveis pelo processamento lógico dos dados
\item[Rotas de interconexão] - fios e barramentos que transportam os sinais digitais pelo circuito
\item[Blocos de entrada e saída] - unidades responsáveis pela comunicação entre o \textit{chip} e componentes externos
\end{description}

Os blocos lógicos são configuráveis e implementam funções lógicas e armazenamento de dados (i.e. memória). Os blocos de E/S recebem e enviam dados para fora do \textit{chip}. Por fim, as rotas de interconexão conectam os blocos lógicos entre si e entre os blocos de E/S. Uma forma de visualizar esses componentes é através de uma matriz, onde os blocos lógicos estão dispostos bidimensionalmente, numa grade, e conectados pelas rotas de interconexão. Nas bordas dessa matriz se encontram os blocos de E/S, integrados à matriz pelas rotas de interconexão, servindo para a comunicação do \textit{FPGA} com dispositivos exteriores a ele.


\subsection{Blocos lógicos}

Os blocos lógicos configuráveis (BLCs) são as unidades que provêm capacidade lógica e de armazenamento para o FPGA. BLCs podem ser implementados de diversas maneiras, desde simples transistores até processadores inteiros, e essa implementação define sua granularidade. BLCs com granularidade muito pequena, como transistores, ocupam muito espaço e os torna ineficientes em termos de área. Por outro lado, os de granularidade muito grande, como processadores, podem representar um desperdício de recurso quando tratamos de funções mais simples.
Entre esses máximos, temos um espectro de implementações de BLCs. 

Os BLCs são compostos por blocos lógicos básicos (BLBs), que podem ser usados em conjunto ou de forma isolada, ou seja, um BLC pode ser composto por um único BLB ou por um conjunto deles. As componentes usadas nos BLBs podem variar, mas a fabricante da placa usada no presente trabalho, a Altera, utiliza \textit{lookup tables} e \textit{flip-flops} para armazenamento. As LUTs são usadas como tabela de valor para representar qualquer função booleana com determinado número de \textit{bits} de entrada e de saída. Assim, uma LUT que recebe $k$ \textit{bits} é chamada de \textit{k-LUT} e representa qualquer função booleana $f$ tal que

\begin{center}
$f: \{0, 1\}^k \rightarrow \{0, 1\}^k $
\end{center}


A vantagem do uso de LUTs e \textit{flip-flops} reside em não ter uma granularidade nem muito pequena, nem muito grande, permitindo o uso em conjunto para implementações mais complexas.

Apesar do uso de LUTs ou outros métodos para implementar BLBs, como NANDs, esses métodos são mais usados para criar a parte programável do FPGA. Uma parte dele pode vir já programada com blocos lógicos especializados, como processadores de sinais digitais (conhecidos como DSPs, \textit{digital signals processor}), multiplicadores, somadores, ALUs inteiras, todos criados de forma otimizada para suas tarefas. Estes são chamados de blocos rígidos, pois não podem ser reprogramados, apenas usados como estão no FPGA. Isso implica em um possível desperdício de espaço e recursos no caso desses blocos não serem utilizados pelo circuito, mas também traz a vantagem de se usar blocos dedicados a determinadas tarefas.

\subsection{Rede de interconexão}

Como já mencionado, a flexibilidade de um FPGA vem da capacidade de ter sua rede de interconexão reprogramada. Essa rede precisa ser flexível não só em termos de configuração de rotas, mas também de tipos de fios presentes no dispositivo para poder implementar uma grande variedade de circuitos. Apesar da maior parte das componentes de um circuito apresentar localidade (isto é, se localizarem perto umas das outras), há conexões que podem necessitar de fios mais longos.
Cerca de 85\% da área de um FPGA consiste da rede de interconexão entre os blocos lógicos. Visando otimizar a comunicação de acordo com a finalidade do circuito, essa rede pode ser construída usando arquiteturas diferentes. A arquitetura utilizada neste trabalho é a baseada em malha.

As redes baseadas em malha (do inglês '\textit{mesh-based}', também conhecida como '\textit{island-style}') são organizadas em formato matricial, com blocos lógicos cercados de fios de conexão - por isso o termo 'estilo de ilha', onde os BLs parecem estar "ilhados" em um "mar de fios". Nas extremidades se encontram os blocos de entrada e saída. Na rede de conexão estão localizadas concentrações de \textit{switches} que estabelecem a rota dos sinais entre os blocos lógicos. Por último, existem as conexões entre os blocos lógicos e a rede de comunicação, que são chamadas de caixas de comunicação, também configuráveis. A figura \ref{fig:mashed-based-fpga} mostra essa arquitetura. Nela, temos os BLCs em rosa, responsáveis pela implementação do processamento de dados do circuito; as caixas de \textit{switchs} programáveis em azul, responsáveis pelo roteamento dos sinais através do circuito; e as caixas de conexão em azul, também responsáveis pelo roteamento dos sinais digitais, mas principalmente pela entrada e saída entre os blocos lógicos e o exterior do \textit{chip}.

\begin{figure}[htb]
\centering
\includegraphics[width=10cm]{figuras/mashed-based-fpga}
\caption{\label{fig:mashed-based-fpga}Exemplo de um FPGA com rede de interconexão em malha. Fonte: ~\cite{fpga:fpga-an-overview}}
\end{figure}

Um exemplo de FPGA que segue o modelo de rede baseada em malha é a Stratix IV, da Altera, com o modelo EP4SGX230 ilustrado na figura \ref{fig:stratix}. A Stratix é uma das famílias de FPGAs industriais da Altera usadas principalmente para aplicações que demandam alto desempenho. O modelo ilustrado, por exemplo, possui $228.000$ elementos lógicos (BLBs) compostos de 4-LUTs e \textit{flip-flops} tipo D, $182.400$ registradores, $91.200$ BLCs, 22 blocos de memória M144K (que guardam até $144$ \textit{kilobits} endereçáveis), dentre outras características que o tornam uma boa escolha para usuários que necessitam de um bom desempenho.

\begin{figure}[htb]
	\centering
	\includegraphics[width=10cm]{figuras/Altera_StratixIV_FPGA}
	\caption{\label{fig:stratix}SoC FPGA usando um FPGA Stratix IV EP4SGX 230, da Altera.}
\end{figure}

\section{Desvantagens}

A maior vantagem de \textit{FPGAs} - sua flexibilidade - também é a causa de sua maior desvantagem. Essa característica baseia-se na reprogramação das rotas de interconexão, dos blocos lógicos e dos blocos de entrada e saída. Entretanto, a área usada por tais rotas ocupa a maior parte do dispositivo, chengando a quase 90\% da área útil do dispositivo, para permitir a sua reprogramação. 
Não obstante, os \textit{switches} e os componentes necessários para implementar as LUTs geram resistência elétrica à propagação dos pulsos de \textit{clock} do sistema, o que obriga os fabricantes a diminuir a frequência máxima de \textit{clock} do \textit{chip} e da placa. Por consequência, os FPGAs são mais lentos e consomem mais energia do que os \textit{ASIC}s.

Outra desvantagem de FPGAs é a programação. Apesar da popularidade de linguagens de descrição de \textit{hardware} no desenvolvimento de ASICs, o uso delas na programação de FPGAs por parte de pessoas leigas da área pode ser um empecilho inicial considerável, dada a necessidade de conhecimentos básicos de circuitos eletrônicos, como sinais de comunicação, protocolos de processamento de dados, máquinas de estados etc. A utilização de linguagens de alto nível, tais como C, para especificar o comportamento do circuito pode ajudar no entendimento desses conceitos básicos de desenvolvimento de \textit{hardware}, sabendo como os elementos e comandos da linguagem são mapeados a componentes do circuito.
